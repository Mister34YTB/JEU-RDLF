<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>√ânigmes - La Roue de la Fortune</title>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

  </script>

  <style>
    body {
      margin: 0;
      background-color: black;
      color: white;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100vh;
      overflow: hidden;
    }

    h1 {
      margin: 20px;
      font-size: 24px;
      color: #ffffff;
    }

    .container {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .row {
      display: flex;
      justify-content: center;
      gap: 5px;
    }

    .box {
      width: 100px;
      height: 100px;
      background-color: #FFA500;
      border: 1px solid #555;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 60px;
      font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;
    }

    .box.red {
      background-color: red !important;
      color: white !important;
    }

    .white {
      background-color: white !important;
      color: black;
    }

    .box.blue {
      background-color: #007BFF;
      color: white;
      font-weight: bold;
      font-size: 2em;
    }

    .buttons {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      gap: 10px;
    }

    .buttons button {
      padding: 10px 20px;
      font-size: 30px;
      margin: 0 5px;
      background-color: #222;
      color: white;
      border: 2px solid #FFD700;
      border-radius: 5px;
      cursor: pointer;
    }

    .buttons button:hover {
      background-color: #FFD700;
      color: black;
    }

    #popup {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    #popup-content {
      background: rgba(0, 0, 0, 0.8);
      padding: 20px;
      border: 2px solid #FFD700;
      border-radius: 10px;
      text-align: center;
      color: white;
      font-size: 24px;
    }

    #popup input {
      font-size: 24px;
      padding: 5px;
      margin-bottom: 10px;
      width: 80%;
      text-transform: uppercase;
    }

    #popup button {
      font-size: 24px;
      padding: 10px 20px;
      margin-top: 10px;
      background-color: #FFD700;
      color: black;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    #timer {
      font-size: 30px;
      margin-left: 20px;
    }

    #theme {
      display: none;
      background-color: #8A2BE2;
      color: white;
      padding: 15px 30px;
      font-size: 28px;
      font-weight: bold;
      border-radius: 20px;
      text-align: center;
      margin: 20px auto;
      box-shadow: 0 0 20px rgba(138, 43, 226, 0.8), 0 0 30px rgba(138, 43, 226, 0.6);
    }
  </style>
</head>

<body>
  <div id="consonne-msg" style="position: fixed; top: 10px; left: 10px; font-size: 20px; color: yellow;"></div>
  <div id="voyelle-msg" style="position: fixed; top: 10px; right: 10px; font-size: 20px; color: yellow;"></div>

  <div id="alert-popup" style="
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: yellow;
    color: black;
    padding: 20px 40px;
    border-radius: 20px;
    font-size: 24px;
    font-weight: bold;
    z-index: 10000;
    text-align: center;
    box-shadow: 0 0 20px rgba(0,0,0,0.5);
  "></div>

  <!-- üéµ Tous les sons -->
  <audio id="success-sound" src="sounds/wheel-of-fortune-sound-effect_soqbyeVw.wav" preload="auto"></audio>
  <audio id="error-sound" src="sounds/Lettre I.wav" preload="auto"></audio>
  <audio id="reveal-sound" src="sounds/wheel-of-fortune-sound-effect_2yl9JNRv.wav" preload="auto"></audio>
  <audio id="alert-sound" src="sounds/plus de consonne.mp3" preload="auto"></audio>
  <audio id="resolved-sound" src="sounds/Enigme Resolue.mp3" preload="auto"></audio>
  <audio id="final-sound-1" src="sounds/Enigme Rapide Resolue.mp3" preload="auto"></audio>
  <audio id="final-sound-2" src="sounds/Finalgagner.mp3" preload="auto"></audio>
  <audio id="countdown-sound" src="sounds/10secondes.mp3" preload="auto"></audio>
  <audio id="buzz-sound" src="sounds/wheel-of-fortune-sound-effect_soqbyeVw.wav" preload="auto"></audio>


  <div id="theme"></div>

  <div class="container" id="grid">
    <div class="row" id="row0"></div>
    <div class="row" id="row1"></div>
    <div class="row" id="row2"></div>
    <div class="row" id="row3"></div>
  </div>

  <div class="buttons">
    <button onclick="setCategory('rapide')">Rapidit√©</button>
    <button onclick="setCategory('enigme')">√ânigme</button>
    <button onclick="setCategory('musique')">Musique</button>
    <button onclick="setCategory('question')">Question</button>
    <button onclick="setCategory('finale')">Finale</button>
    <button onclick="resetUsedEnigmes()">üîÑ R√©initialiser</button>
    <button onclick="resetBuzzers()">üîÑ R√©initialiser Buzzers</button>


    <div id="timer"></div>
  </div>

  <div id="solution" style="margin-top: 50px; font-size: 24px; color: #FFD700;"></div>

  <div id="popup">
    <div id="popup-content">
      <p>Choisissez 3 consonnes :</p>
      <input type="text" id="consonnes" maxlength="3" />
      <p>Choisissez 1 voyelle :</p>
      <input type="text" id="voyelle" maxlength="1" />
      <br>
      <button onclick="submitLetters()">Valider</button>
    </div>
  </div>

 <!-- Liste des joueurs -->
<div id="playersList" style="
  position:fixed; bottom:10px; left:10px;
  background:rgba(0,0,0,0.7);
  padding:15px;
  border:2px solid #FFD700;
  border-radius:10px;
  font-size:20px;
  color:white;
  max-width:250px;
">
</div>

<script src="/socket.io/socket.io.js"></script>

  <script>
let countdownInterval = null;
const structure = [12, 14, 14, 12];
const usedEnigmes = {
  rapide: [],
  enigme: [],
  musique: [],
  question: [],
  finale: []
};
loadUsedEnigmes();

const enigmesRapidit√© = [
      { theme: "√Ä TUE-T√äTE", texte: "CHANTER UNE RITOURNELLE" },
      { theme: "√Ä LA PLAGE", texte: "PORTER UN MAILLOT DE BAIN" },
      { theme: "PARLEZ-VOUS FRAN√áAIS ?", texte: "DIRE UNE LAPALISSADE" },
      { theme: "ZEN", texte: "LA POSTURE DE L'ENFANT" },
      { theme: "VROOM VROOM", texte: "SEBASTIEN LOEB" },
      { theme: "MIAM !", texte: "UN BOUCHON LYONNAIS" },
      { theme: "OBJET INSOLITE", texte: "UNE HORLOGE INVERSEE" },
      { theme: "JACKPOT !", texte: "UNE PARTIE DE KENO" },



    ];

    const enigmesMusique = [
      { theme: "MUSIQUE", texte: " <A SKY FULL OF STARS> & <VIVA LA VIDA>" },
    ];

    const enigmesQuestion = [
      { theme: "EN FRANCE", texte: "DANS QUEL DEPARTEMENT SE TROUVE LE TUNNEL 'RICARD' ?" },
    ];

    const enigmesEnigme = [
      { theme: "C'EST LA F√äTE !", texte: "UN ENTERREMENT DE VIE DE JEUNE FILLE" },
      { theme: "QUESTION EXISTENTIELLE", texte: "APPELER UN PAIN AU CHOCOLAT UNE CHOCOLATINE" },
      { theme: "LIEU OU MONUMENT", texte: "LE CHRIST REDEMPTEUR DE RIO DE JANEIRO" }
    ];

    const enigmesFinale = [
      { theme: "M√âTIER", texte: "DACTYLOGRAPHE" },
    ];

let currentFinale = null;
let finalePhase = false;
let currentCategory = null;
let rapidRevealInterval = null;
let rapidBoxes = [];
let rapidLetters = [];
let isRevealing = false;

function saveUsedEnigmes() {
  localStorage.setItem('usedEnigmes', JSON.stringify(usedEnigmes));
}
function loadUsedEnigmes() {
  const stored = localStorage.getItem('usedEnigmes');
  if (stored) {
    const parsed = JSON.parse(stored);
    for (const cat in usedEnigmes) {
      if (parsed[cat]) {
        usedEnigmes[cat] = parsed[cat];
      }
    }
  }
}

function initGrid() {
  for (let i = 0; i < 4; i++) {
    const row = document.getElementById(`row${i}`);
    row.innerHTML = '';
    for (let j = 0; j < structure[i]; j++) {
      const box = document.createElement('div');
      box.classList.add('box');
      row.appendChild(box);
    }
  }
}
initGrid();

function setCategory(category) {
  resetLetterAlerts();
  currentCategory = category;
  finalePhase = (category === "finale");
  playSound("reveal-sound");

  let pool;
  switch (category) {
    case "rapide": pool = enigmesRapidit√©; break;
    case "musique": pool = enigmesMusique; break;
    case "question": pool = enigmesQuestion; break;
    case "enigme": pool = enigmesEnigme; break;
    case "finale": pool = enigmesFinale; break;
    default: return;
  }

  const nonJouees = pool.filter(
    (enigme) => !usedEnigmes[category].includes(enigme.texte)
  );

  if (nonJouees.length === 0) {
    alert(`Toutes les √©nigmes de la cat√©gorie "${category}" ont √©t√© jou√©es.`);
    return;
  }

  const pick = nonJouees[Math.floor(Math.random() * nonJouees.length)];
  usedEnigmes[category].push(pick.texte);
  saveUsedEnigmes();

  const words = pick.texte.toUpperCase().split(" ");
  document.getElementById("theme").innerText = pick.theme.toUpperCase();
  document.getElementById("theme").style.display = "inline-block";

  initGrid();

  let currentLine = 0;
  const linesContent = ["", "", "", ""];
  for (const word of words) {
    const tentative = (linesContent[currentLine] + " " + word).trim();
    if (tentative.length <= structure[currentLine]) {
      linesContent[currentLine] = tentative;
    } else {
      currentLine++;
      if (currentLine >= structure.length) {
        alert("L'√©nigme est trop longue pour √™tre affich√©e.");
        return;
      }
      linesContent[currentLine] = word;
    }
  }

  rapidBoxes = [];
  rapidLetters = [];

  for (let i = 0; i < linesContent.length; i++) {
    const row = document.getElementById(`row${i}`);
    const boxesInLine = Array.from(row.children);
    const letters = linesContent[i].split("");
    const start = Math.floor((structure[i] - letters.length) / 2);
    for (let j = 0; j < letters.length; j++) {
      const letter = letters[j];
      const box = boxesInLine[start + j];
      if (letter === " ") continue;
      box.classList.add("white");
      if (letter.match(/[A-Z]/)) {
        box.innerText = "";
        box.setAttribute("data-letter", letter);
        if (category === "rapide") {
          rapidBoxes.push(box);
          rapidLetters.push(letter);
        }
      } else {
        box.innerText = letter;
        box.style.fontSize = "3.5em";
        box.style.color = "black";
      }
    }
  }

  document.getElementById("solution").innerText = `üí° Solution : ${pick.texte}`;

  socket.emit("updateBoard", {
    theme: document.getElementById("theme").innerText,
    grid: document.getElementById("grid").innerHTML
  });
}

function toggleRapidReveal() {
  if (isRevealing) {
    clearInterval(rapidRevealInterval);
    isRevealing = false;
    return;
  }

  isRevealing = true;

  const unrevealed = rapidBoxes
    .map((box, index) => ({ box, letter: rapidLetters[index] }))
    .filter(item => item.box.innerText === '');

  rapidRevealInterval = setInterval(() => {
    if (unrevealed.length === 0) {
      clearInterval(rapidRevealInterval);
      isRevealing = false;
      return;
    }

    const i = Math.floor(Math.random() * unrevealed.length);
    const { box, letter } = unrevealed.splice(i, 1)[0];
    box.innerText = letter;

    socket.emit("updateBoard", {
      theme: document.getElementById("theme").innerText,
      grid: document.getElementById("grid").innerHTML
    });
  }, 1500);
}

function revealLetters(letters, callback = null) {
  const whiteBoxes = Array.from(document.querySelectorAll('.box.white'));
  let delay = 0;

  letters.forEach((letter, lIndex) => {
    const targets = whiteBoxes.filter(box =>
      box.getAttribute('data-letter') === letter && box.innerText === ''
    );

    targets.forEach((box, idx) => {
      setTimeout(() => {
        box.classList.remove('white');
        box.classList.add('blue');
      }, delay);

      setTimeout(() => {
        box.classList.remove('blue');
        box.classList.add('white');
        box.innerText = letter;

        socket.emit("updateBoard", {
          theme: document.getElementById("theme").innerText,
          grid: document.getElementById("grid").innerHTML
        });

        if (
          lIndex === letters.length - 1 &&
          idx === targets.length - 1 &&
          typeof callback === 'function'
        ) {
          callback();
        }
      }, delay + 600);

      delay += 300;
    });
  });
}

function revealAllLetters() {
  clearInterval(rapidRevealInterval);
  isRevealing = false;
  const whiteBoxes = document.querySelectorAll('.box.white');
  whiteBoxes.forEach(box => {
    const letter = box.getAttribute('data-letter');
    if (letter && box.innerText === '') {
      box.innerText = letter;
    }
  });

  socket.emit("updateBoard", {
    theme: document.getElementById("theme").innerText,
    grid: document.getElementById("grid").innerHTML
  });
}

  let buzzerEnabled = false;

  function toggleBuzzer() {
    buzzerEnabled = !buzzerEnabled;
    socket.emit("buzzerState", buzzerEnabled);
    // (facultatif) feedback visuel local
    document.getElementById('toggle-buzz').textContent =
      buzzerEnabled ? "üö® D√©sactiver Buzzer" : "üö® Activer Buzzer";
  }


function showPopup() {
  document.getElementById('popup').style.display = 'flex';
}

function submitLetters() {
  const consInput = document.getElementById('consonnes').value.toUpperCase().replace(/[^A-Z]/g, '').slice(0, 3);
  const voyInput = document.getElementById('voyelle').value.toUpperCase().replace(/[^A-Z]/g, '').charAt(0);
  document.getElementById('popup').style.display = 'none';
  const lettersToReveal = [...consInput, voyInput];

  const whiteBoxes = Array.from(document.querySelectorAll('.box.white'));
  const matches = whiteBoxes.filter(box => lettersToReveal.includes(box.getAttribute('data-letter')));

  if (matches.length === 0) {
    // ‚ùå aucune lettre trouv√©e ‚Üí erreur directe
    triggerLetterError();
    setTimeout(() => startCountdown(), 1000); // on attend un peu pour lancer le chrono
  } else {
    // ‚úÖ il y a des lettres ‚Üí on r√©v√®le normalement
    revealLetters(lettersToReveal, () => {
      startCountdown(); // chrono apr√®s la derni√®re lettre
    });
  }
}
function submitLetters() {
  const consInput = document.getElementById('consonnes').value
    .toUpperCase().replace(/[^A-Z]/g, '').slice(0, 3);
  const voyInput = document.getElementById('voyelle').value
    .toUpperCase().replace(/[^A-Z]/g, '').charAt(0);
  document.getElementById('popup').style.display = 'none';
  const lettersToReveal = [...consInput, voyInput];

  const whiteBoxes = Array.from(document.querySelectorAll('.box.white'));
  const matches = whiteBoxes.filter(
    box => lettersToReveal.includes(box.getAttribute('data-letter'))
  );

  if (matches.length === 0) {
    // aucune lettre trouv√©e
    triggerLetterError();
    setTimeout(() => startCountdown(), 1000);
  } else {
    revealLetters(lettersToReveal, () => {
      startCountdown();
    });
  }
}


function startCountdown() {
  let timeLeft = 10;
  const timerEl = document.getElementById("timer");
  timerEl.innerText = timeLeft;

  const countdownSound = document.getElementById("countdown-sound");
  if (countdownSound) {
    countdownSound.currentTime = 0;
    countdownSound.play();
  }

  socket.emit("startCountdown"); // pr√©venir les joueurs

  countdownInterval = setInterval(() => {
    timeLeft--;
    timerEl.innerText = timeLeft;
    if (timeLeft <= 0) {
      clearInterval(countdownInterval);
      timerEl.innerText = "";
    }
  }, 1000);
}




document.addEventListener('keydown', function (e) {
  if (document.activeElement.tagName === 'INPUT') return;
  const key = e.key.toUpperCase();

  if (currentCategory === 'rapide' && e.code === 'Space') {
    e.preventDefault();
    toggleRapidReveal();
    return;
  }

  if (e.code === 'Enter') {
    if (countdownInterval !== null) {
      clearInterval(countdownInterval);
      countdownInterval = null;
      document.getElementById('timer').innerText = '';
      const countdownSound = document.getElementById('countdown-sound');
      if (countdownSound) {
        countdownSound.pause();
        countdownSound.currentTime = 0;
      }
    }

    if (finalePhase) {
      playSound("final-sound-1");
      setTimeout(() => playSound("final-sound-2"), 2000);
    } else {
      playSound("resolved-sound");
    }

    revealAllLetters();
    return;
  }

  if (finalePhase && e.code === 'Space') {
    e.preventDefault();
    revealLetters(['R', 'S', 'T', 'L', 'N', 'E'], () => {
      setTimeout(showPopup, 3000);
    });
  }

  if (!/^[A-Z]$/.test(key) || currentCategory === 'rapide') return;

  const whiteBoxes = Array.from(document.querySelectorAll('.box.white'));
  const alreadyRevealed = whiteBoxes.filter(box => box.getAttribute('data-letter') === key && box.innerText === key);
  const unrevealed = whiteBoxes.filter(box => box.getAttribute('data-letter') === key && box.innerText === '');

  if (unrevealed.length > 0) {
    playSound("success-sound");
    unrevealed.forEach((box, index) => {
      setTimeout(() => {
        box.classList.remove('white');
        box.classList.add('blue');
      }, index * 300);

      setTimeout(() => {
        box.classList.remove('blue');
        box.classList.add('white');
        box.innerText = key;

        socket.emit("updateBoard", {
          theme: document.getElementById("theme").innerText,
          grid: document.getElementById("grid").innerHTML
        });

        if (index === unrevealed.length - 1) {
          checkLetterCompletion();
        }
      }, unrevealed.length * 300 + index * 300);
    });
  } else if (alreadyRevealed.length > 0) {
    triggerLetterError();
    alreadyRevealed.forEach(box => {
      box.classList.add('red');
      setTimeout(() => {
        box.classList.remove('red');
      }, 500);
    });
  } else {
    triggerLetterError();
    whiteBoxes.forEach(box => box.classList.add('red'));
    setTimeout(() => {
      whiteBoxes.forEach(box => box.classList.remove('red'));
    }, 500);
  }
});

function showSolution() {
  if (currentFinale && currentFinale.texte) {
    document.getElementById('solution').innerText = `üí° Solution : ${currentFinale.texte}`;
  }
}

function resetUsedEnigmes() {
  if (confirm("Voulez-vous vraiment r√©initialiser toutes les √©nigmes jou√©es ?")) {
    for (const cat in usedEnigmes) {
      usedEnigmes[cat] = [];
    }
    localStorage.removeItem('usedEnigmes');
    alert("Toutes les √©nigmes ont √©t√© r√©activ√©es !");
  }
}

function showTemporaryAlert(message, type) {
  const popup = document.getElementById('alert-popup');
  popup.innerText = message;
  popup.style.display = 'block';

  playSound("alert-sound");

  setTimeout(() => {
    popup.style.display = 'none';

    if (type === 'consonne') {
      document.getElementById('consonne-msg').innerText = '‚û§ Plus de consonne';
    } else if (type === 'voyelle') {
      document.getElementById('voyelle-msg').innerText = '‚û§ Plus de voyelle';
    }
  }, 3000);
}

function checkLetterCompletion() {
  const whiteBoxes = Array.from(document.querySelectorAll('.box.white'));
  const unrevealed = whiteBoxes.filter(box => box.innerText === '');
  const remainingLetters = unrevealed.map(box => box.getAttribute('data-letter'));

  const consonnesRestantes = remainingLetters.filter(l => !"AEIOUY".includes(l));
  const voyellesRestantes = remainingLetters.filter(l => "AEIOUY".includes(l));

  if (consonnesRestantes.length === 0 && !document.getElementById('consonne-msg').innerText) {
    showTemporaryAlert("Plus de consonne", 'consonne');
  }
  if (voyellesRestantes.length === 0 && !document.getElementById('voyelle-msg').innerText) {
    showTemporaryAlert("Plus de voyelle", 'voyelle');
  }
}

function resetLetterAlerts() {
  document.getElementById('consonne-msg').innerText = '';
  document.getElementById('voyelle-msg').innerText = '';
}

function playSound(id) {
  socket.emit("playSound", id); // admin d√©clenche uniquement
}



  // affiche la liste des joueurs
socket.on("playersUpdate", (players) => {
  const listDiv = document.getElementById("playersList");

  // S√©pare joueurs et spectateurs
  const activePlayers = players.filter(p => p.role === "player");
  const spectators = players.filter(p => p.role === "spectator");

  // Construire la liste des joueurs
  const playersHtml = activePlayers.map(p =>
    `<div style="color:${p.color || 'white'}; font-weight:bold;" id="player-${p.name}">
       ${p.name}
       <span class="buzz-controls"></span>
     </div>`
  ).join("");

  // Affiche le nombre de spectateurs
  const spectatorsHtml = `<div style="margin-top:10px; font-size:16px; color:#ccc;">
     üëÄ Spectateurs : ${spectators.length}
  </div>`;

  listDiv.innerHTML = playersHtml + spectatorsHtml;
});


  // fond de couleur quand buzz
  socket.on("buzzed", ({ playerName, color }) => {
  document.body.style.backgroundColor = color;
  console.log(`üö® BUZZ : ${playerName}`);

  // on ajoute les boutons √† c√¥t√© du joueur qui buzz
  const playerDiv = document.querySelector(`#player-${playerName} .buzz-controls`);
  if (playerDiv) {
    playerDiv.innerHTML = `
      <button style="background:green;color:white;font-weight:bold;margin-left:10px;" 
              onclick="validateBuzz('${playerName}')">‚úî</button>
      <button style="background:red;color:white;font-weight:bold;margin-left:5px;" 
              onclick="invalidateBuzz('${playerName}')">‚úò</button>
    `;
  }
});
  // reset => fond noir
  socket.on("resetBuzzers", () => {
    document.body.style.backgroundColor = "black";
  });

  function resetBuzzers() {
    socket.emit("resetBuzzers");
  }
socket.on("playSound", (id) => {
  const s = document.getElementById(id);
  if (s) {
    s.currentTime = 0;
    s.play();
  }
});

function triggerLetterError() {
  playSound("error-sound");
  socket.emit("letterError");
}

socket.on("letterError", () => {
  const whiteBoxes = document.querySelectorAll('.box.white');
  whiteBoxes.forEach(box => box.classList.add('red'));
  setTimeout(() => {
    whiteBoxes.forEach(box => box.classList.remove('red'));
  }, 500);
});

function validateBuzz(playerName) {
  console.log(`‚úÖ R√©ponse valid√©e pour ${playerName}`);
  revealAllLetters();        // r√©v√®le toute l‚Äô√©nigme
  playSound("resolved-sound");
  resetBuzzers();
}

function invalidateBuzz(playerName) {
  console.log(`‚ùå Mauvaise r√©ponse pour ${playerName}`);
  triggerLetterError();      // joue le son erreur
  resetBuzzers();
}

</script>
</body>
</html>
